<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IMD 2025 — Re-weightable (LSOA/MSOA)</title>

  <!-- Leaflet (like your other map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer crossorigin="anonymous"></script>

  <!-- CSV + projection helpers -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js" defer></script>

  <style>
    :root { --bg:#0b0f19; --panel:#212F47; --text:#e8ecf3; --muted:#c3ccda; --accent:#4f8cff; --border:#2f3e5b; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:auto 1fr;height:100%}
    header{grid-column:1/-1;padding:10px 16px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-weight:800;font-size:20px;letter-spacing:.4px;text-transform:uppercase}
    .sub{color:var(--muted);font-size:12px}
    aside{border-right:1px solid var(--border);background:var(--panel);padding:14px;overflow:auto}
    main{position:relative}
    #map{height:100%;width:100%;min-height:400px}
    .group{margin-bottom:16px}
    .group label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="range"],button{width:100%;box-sizing:border-box;background:#0e1424;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .row{background:#0e1424;border:1px solid var(--border);border-radius:12px;padding:8px 10px;margin-bottom:10px}
    .legend{position:absolute;bottom:16px;right:16px;background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:12px;line-height:1.2;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:1000}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .swatch{width:16px;height:12px;border-radius:2px;border:1px solid rgba(255,255,255,.1)}
    .tooltip{background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;font-size:12px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .row-inline{display:flex;gap:8px;align-items:center}
    .btns{display:flex;gap:8px}
    .outline{background:transparent;border-color:#b3ceee;color:#b3ceee}
    @media(max-width:900px){#app{grid-template-columns:1fr}#map{height:60vh}}
  </style>
</head>
<body>
<div id="app">
  <header>
    <div>
      <h1>New Horizon Economics | IMD 2025 — Re-weightable (LSOA/MSOA)</h1>
      <div class="sub">Interactive choropleth · File 9 domains · slider-weighted composite</div>
    </div>
  </header>

  <aside>
    <div class="group">
      <div class="row-inline">
        <button id="fitBtn">Reset map</button>
        <button id="legendToggle" class="outline" style="flex:1">Hide legend</button>
      </div>
    </div>

    <div id="sliders"></div>

    <div class="group btns">
      <button id="reset">Reset weights</button>
      <button id="exportCsv" class="outline">Export CSV</button>
      <button id="exportGeo" class="outline">Export GeoJSON</button>
    </div>

    <div class="group" style="font-size:12px;color:var(--muted)">
      Data: <code>/data/areas.geojson</code>, <code>/data/file9.csv</code> (headers must include domain columns).
    </div>
  </aside>

  <main>
    <div id="map"></div>
    <div id="legend" class="legend"></div>
  </main>
</div>

<script defer>
(function(){
  // --- Config
  const GEO_URL = '/data/areas.geojson'; // your file (plural)
  const CSV_URL = '/data/file9.csv';

  const DOMAIN_KEYS = [
    ["dom_income","Income"],
    ["dom_employment","Employment"],
    ["dom_education","Education"],
    ["dom_health","Health"],
    ["dom_crime","Crime"],
    ["dom_barriers","Barriers to Housing & Services"],
    ["dom_living","Living Environment"],
  ];
  const DEFAULT_WEIGHTS = { dom_income:22.5, dom_employment:22.5, dom_education:13.5, dom_health:13.5, dom_crime:9.3, dom_barriers:9.3, dom_living:9.3 };
  const DOMAIN_ALIASES = {
    dom_income:/income/i, dom_employment:/employ/i, dom_education:/educ/i,
    dom_health:/health/i, dom_crime:/crime/i, dom_barriers:/(barrier|housing|access)/i,
    dom_living:/(living|environment)/i
  };
// --- Schema is explicit based on your files ---

// File9 mapping (no guessing)
// File9 mapping (fixed to your headers)
const DK_MAP = {
  dom_income: "income",
  dom_employment: "employ",
  dom_education: "educ",
  dom_health: "health",
  dom_crime: "crime",
  dom_barriers: "barrier",
  dom_living: "living",
};
const codeCol = "AREACD";          // in file9.csv
const GEO_CODE_KEY = "AREACD";     // in areas.geojson
const GEO_NAME_KEY = "AREANM";     // in areas.geojson


// Red → white → green (1=red, 5=white, 10=green)
const PALETTE = [
  "#d73027", "#f46d43", "#fdae61", "#fee08b", "#ffffff",
  "#e6f5d0", "#a1d76a", "#66bd63", "#1a9850", "#006837"
];


  const NO_DATA_FILL = "#3a4258";

  // --- State
 let map, layer, areasFC=null, file9=[];

  const weights = {...DEFAULT_WEIGHTS};
  let legendVisible = JSON.parse(localStorage.getItem('legendVisible') ?? 'true');

  // --- Utils
  const firstXY = (c)=> {
    if (!c) return null;
    if (typeof c[0] === 'number') return c;
    for (const d of c){ const v = firstXY(d); if (v) return v; }
    return null;
  };
  function looksLike27700(gj){
    try{ const xy = firstXY(gj?.features?.[0]?.geometry?.coordinates)||[];
      const [x,y]=xy; return Math.abs(x)>180||Math.abs(y)>90; } catch{ return false; }
  }
  const EPSG27700_DEF = '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,125.157,542.06,0.1502,0.2470,0.8421,-20.4894 +units=m +no_defs';
  function reproject27700toWGS84(gj){
    if (!window.proj4) return gj;
    proj4.defs('EPSG:27700', EPSG27700_DEF);
    const fwd = (xy)=> proj4('EPSG:27700','WGS84',xy);
    function rp(coords){
      if (typeof coords[0]==='number'){ const [x,y]=coords; const [lon,lat]=fwd([x,y]); return [lon,lat]; }
      return coords.map(rp);
    }
    const out = JSON.parse(JSON.stringify(gj));
    for (const f of out.features){ if (f.geometry?.coordinates){ f.geometry.coordinates = rp(f.geometry.coordinates); } }
    return out;
  }

  function normalizeWeights(w){
    const s = Object.values(w).reduce((a,b)=>a+(b||0),0) || 1;
    const o={}; for (const k in w) o[k]= (w[k]||0)/s; return o;
  }
  function weightedScore(row,normW,DK_MAP){
    let s=0; for (const k in DK_MAP){ s += Number(row[DK_MAP[k]]) * (normW[k]||0); } return s;
  }
  function rankAndDeciles(vals){
    const idx = vals.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v);
    const ranks=new Array(vals.length).fill(0), dec=new Array(vals.length).fill(0);
    idx.forEach((o,p)=>{ ranks[o.i]=p+1; const d=Math.ceil(((p+1)/vals.length)*10); dec[o.i]=Math.min(10,Math.max(1,d)); });
    return {ranks,deciles:dec};
  }
  function colorFor(dec){
    if(!Number.isFinite(dec)) return NO_DATA_FILL;
    const i = Math.max(1, Math.min(10, dec)) - 1;
    return PALETTE[i];
  }
// --- Robust coercions (handles commas, spaces, BOM, weird minus signs)
const cleanStr = v => String(v ?? "")
  .replace(/^\uFEFF/, "")         // strip BOM
  .trim();

const num = v => {
  const s = cleanStr(v).replace(/[\s,]/g, "").replace(/[−–—]/g, "-");
  const x = +s;
  return Number.isFinite(x) ? x : NaN;
};

  // --- UI (sliders & legend)
  const slidersDiv = document.getElementById('sliders');
  const normLabel = {};
  function renderSliders(){
    slidersDiv.innerHTML='';
    const norm = normalizeWeights(weights);
    DOMAIN_KEYS.forEach(([key,label])=>{
      const wrap=document.createElement('div'); wrap.className='row';
      const top=document.createElement('label'); top.innerHTML=`<span>${label}</span><span id="lab-${key}">${(norm[key]*100).toFixed(1)}%</span>`;
      const input=document.createElement('input'); input.type='range'; input.min='0'; input.max='40'; input.step='0.1'; input.value=String(weights[key]);
      input.addEventListener('input',()=>{ weights[key]=Number(input.value); updateAll(); });
      wrap.appendChild(top); wrap.appendChild(input); slidersDiv.appendChild(wrap);
      normLabel[key]=top.querySelector('span:last-child');
    });
  }
  function updateLegend(){
    const el = document.getElementById('legend');
    let html = `<div style="font-weight:700;margin-bottom:6px">Deciles (1 = most deprived)</div>`;
    for(let i=0;i<10;i++){
      html += `<div class="row"><span class="swatch" style="background:${PALETTE[i]}"></span> ${i+1}</div>`;
    }
    html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`;
    el.innerHTML = html;
    el.style.display = legendVisible ? 'block' : 'none';
    document.getElementById('legendToggle').textContent = legendVisible ? 'Hide legend' : 'Show legend';
  }

  // --- Map bootstrap
  window.addEventListener('DOMContentLoaded', async ()=>{
    map = L.map('map',{preferCanvas:true,zoomSnap:0.25,zoomDelta:0.5}).setView([53.9,-2.5],6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                {attribution:'&copy; OpenStreetMap, &copy; CARTO'}).addTo(map);

    document.getElementById('fitBtn').addEventListener('click', ()=>{ if(layer) map.fitBounds(layer.getBounds(),{padding:[20,20]}); });
    document.getElementById('legendToggle').addEventListener('click', ()=>{
      legendVisible = !legendVisible; updateLegend(); localStorage.setItem('legendVisible', JSON.stringify(legendVisible));
    });
    document.getElementById('reset').addEventListener('click', ()=>{ Object.assign(weights, DEFAULT_WEIGHTS); renderSliders(); updateAll(); });
    document.getElementById('exportCsv').addEventListener('click', exportCSV);
    document.getElementById('exportGeo').addEventListener('click', exportGeo);

    renderSliders(); updateLegend();

     try {
    // ---- load geojson
    const g = await fetch(GEO_URL, {cache:'no-store'});
    if (!g.ok) throw new Error('Geo fetch failed: '+g.status);
    const raw = await g.json();
    areasFC = looksLike27700(raw) ? reproject27700toWGS84(raw) : raw;
console.log("[GEO] feature props sample:", areasFC?.features?.[0]?.properties);

    // ---- load file9 (auto-detect delimiter CSV/TSV)
    const res = await fetch(CSV_URL, {cache:'no-store'});
    if (!res.ok) throw new Error('CSV fetch failed: '+res.status);
    const txt = await res.text();
    const guessTab = txt.split('\n',1)[0].includes('\t');
    const parsed = Papa.parse(txt, {
      header: true, dynamicTyping: false, skipEmptyLines: true,
      delimiter: guessTab ? '\t' : ','
    });
  file9 = (parsed.data || []).map(r => ({
  AREACD: cleanStr(r.AREACD).toUpperCase(),  // force uppercase & trim
  income:  num(r.income),
  employ:  num(r.employ),
  educ:    num(r.educ),
  health:  num(r.health),
  crime:   num(r.crime),
  barrier: num(r.barrier),
  living:  num(r.living),
}));

// quick sanity log
console.log("[FILE9] rows:", file9.length, "sample:", file9[0]);


  function draw(){
    if(layer) { map.removeLayer(layer); layer=null; }
    layer = L.geoJSON(areasFC, {
      style: ()=>({color:'#9fb6e6',weight:1.1,fillColor:NO_DATA_FILL,fillOpacity:0.9}),
      onEachFeature: (f,l)=>{
        l.on({
          mouseover:e=>{ e.target.setStyle({weight:2,color:'#fff',fillColor:e.target._currentFill,fillOpacity:1}); },
          mouseout:e=>{ e.target.setStyle({weight:1.1,color:'#9fb6e6',fillColor:e.target._currentFill,fillOpacity:0.9}); },
          click:()=> map.fitBounds(l.getBounds(), {maxZoom:11})
        });
      }
    }).addTo(map);
    map.fitBounds(layer.getBounds(),{padding:[20,20]});
  }



 // =====================================================
//  updateAll() — joins File9 to the map and colours areas
// =====================================================
function updateAll() {
  // --- weights are fixed (you can skip this if not reweighting) ---
  const normW = normalizeWeights(DEFAULT_WEIGHTS); // or your weights logic

  // --- compute composite score and decile per row ---
const scores = file9.map(r =>
  r.income  * normW.dom_income     +
  r.employ  * normW.dom_employment +
  r.educ    * normW.dom_education  +
  r.health  * normW.dom_health     +
  r.crime   * normW.dom_crime      +
  r.barrier * normW.dom_barriers   +
  r.living  * normW.dom_living
);



  const { ranks, deciles } = rankAndDeciles(scores);

  // --- build index for quick lookup ---
  const idx = new Map();
file9.forEach((r,i) => idx.set(r.AREACD, i));


  // --- colour each polygon ---
  let matched=0,total=0;
  layer.eachLayer(l=>{
    total++;
   const props = l.feature?.properties || {};
const code  = cleanStr(props.AREACD).toUpperCase();
const i     = idx.get(code);

    const dec = (i!=null) ? deciles[i] : NaN;

    const fill = colorFor(dec);
    l._currentFill = fill;
    l.setStyle({ fillColor: fill });

    const name = props.AREANM || code || "Area";
    const content = `<div><strong>${name}</strong><br/><span style="opacity:.75">${code}</span><br/>Decile: <strong>${Number.isFinite(dec)?dec:'—'}</strong></div>`;
    l.bindTooltip(content, { sticky:true, opacity:0.95, className:'tooltip' });

    if(Number.isFinite(dec)) matched++;
  });

  console.log(`[JOIN] matched ${matched} of ${total} features`);
  updateLegend();
// how many polygons matched and how many NaNs in scores?
const nanScores = scores.filter(x => !Number.isFinite(x)).length;
console.log(`[JOIN] matched ${matched} of ${total} features | NaN scores: ${nanScores}/${scores.length}`);

}

  function exportCSV(){
    if(!file9) return;
    const normW = normalizeWeights(weights);
    const scores = file9.map(r=>weightedScore(r,normW,DK_MAP));
    const {ranks,deciles} = rankAndDeciles(scores);
    const rows=[]; const idx=new Map(); file9.forEach((r,i)=> idx.set(String(r[codeCol]).trim(),i));
    for(const [code,i] of idx.entries()){
      rows.push({AREACD:code,score:scores[i],rank:ranks[i],decile:deciles[i]});
    }
    const cols=['AREACD','score','rank','decile'];
    const esc=s=>`"${String(s).replaceAll('"','""')}"`;
    const csv=[cols.map(esc).join(','), ...rows.map(r=>cols.map(c=>esc(r[c])).join(','))].join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=`imd_bespoke_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  }

  function exportGeo(){
    if(!areasFC||!file9) return;
    const normW = normalizeWeights(weights);
    const scores = file9.map(r=>weightedScore(r,normW,DK_MAP));
    const {ranks,deciles} = rankAndDeciles(scores);
    const idx=new Map(); file9.forEach((r,i)=> idx.set(String(r[codeCol]).trim(),i));
    const out = {
      type:'FeatureCollection',
      features: areasFC.features.map(ft=>{
        const code = String(ft.properties?.AREACD ?? ft.id ?? '').trim();
        const i = idx.get(code);
        return {
          ...ft,
          properties:{
            ...ft.properties,
            _score: (i!=null? scores[i] : null),
            _rank: (i!=null? ranks[i] : null),
            _decile: (i!=null? deciles[i] : null)
          }
        };
      })
    };
    const blob = new Blob([JSON.stringify(out)],{type:'application/geo+json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`imd_bespoke_${new Date().toISOString().slice(0,10)}.geojson`; a.click(); URL.revokeObjectURL(url);
  }
})();
</script>
</body>
</html>
