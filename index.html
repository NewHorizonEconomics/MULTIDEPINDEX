<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>IMD 2025 — Re-weightable (LSOA/MSOA)</title>

  <!-- Leaflet (like your other map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer crossorigin="anonymous"></script>

  <!-- CSV + projection helpers -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js" defer></script>

  <style>
    :root { --bg:#0b0f19; --panel:#212F47; --text:#e8ecf3; --muted:#c3ccda; --accent:#4f8cff; --border:#2f3e5b; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:auto 1fr;height:100%}
   header {
  grid-column: 1 / -1;
  padding: 10px 16px;
  border-bottom: 1px solid var(--border);
  background: var(--panel);
}

/* new wrapper inside header */
.brand {
  display: flex;
  align-items: center;
  gap: 12px;
}

/* existing heading & subtext */
header h1 {
  margin: 0;
  font-weight: 800;
  font-size: 20px;
  letter-spacing: .4px;
  text-transform: uppercase;
}

.sub {
  color: var(--muted);
  font-size: 12px;
}

/* logo styling */
.brand .logo {
  width: 40px;          /* adjust size */
  height: 40px;
  border-radius: 50%;   /* optional – remove if square logo */
  object-fit: cover;
  border: 2px solid rgba(255,255,255,.08);
}

    aside{border-right:1px solid var(--border);background:var(--panel);padding:14px;overflow:auto}
    main{position:relative}
    #map{height:100%;width:100%;min-height:400px}
    .group{margin-bottom:16px}
    .group label{display:flex;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
    input[type="range"],button{width:100%;box-sizing:border-box;background:#0e1424;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
    .row{background:#0e1424;border:1px solid var(--border);border-radius:12px;padding:8px 10px;margin-bottom:10px}
    .legend{position:absolute;bottom:16px;right:16px;background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;font-size:12px;line-height:1.2;box-shadow:0 10px 24px rgba(0,0,0,.25);z-index:1000}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .swatch{width:16px;height:12px;border-radius:2px;border:1px solid rgba(255,255,255,.1)}
    .tooltip{background:rgba(20,26,42,.96);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;font-size:12px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .row-inline{display:flex;gap:8px;align-items:center}
    .btns{display:flex;gap:8px}
    .outline{background:transparent;border-color:#b3ceee;color:#b3ceee}
    @media(max-width:900px){#app{grid-template-columns:1fr}#map{height:60vh}}
  /* Mobile: make the top band clearly scrollable */
@media (max-width: 900px) {
  aside {
    position: relative;
    max-height: 38vh;          /* visible but not overwhelming */
    overflow-y: auto;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 22px;      /* room for the hint fade */
  }

  /* Fading masks to hint there’s more content */
  aside::before,
  aside::after {
    content: "";
    position: sticky;
    left: 0; right: 0;
    height: 18px;
    pointer-events: none;
    z-index: 2;
  }
  /* top fade (appears when scrolled down) */
  aside::before {
    top: 0;
    background: linear-gradient(to bottom, var(--panel), transparent);
    display: none;
  }
  /* bottom fade + subtle “scroll” cue */
  aside::after {
    bottom: 0;
    background:
      linear-gradient(to top, var(--panel), transparent),
      radial-gradient(circle at 50% 85%, rgba(255,255,255,0.15) 0 6px, transparent 7px);
  }

  /* Tiny text hint over the bottom fade (first load only) */
  aside .scroll-hint {
    position: sticky;
    bottom: 4px;
    width: 100%;
    text-align: center;
    font-size: 10px;
    color: var(--muted);
    z-index: 3;
    pointer-events: none;
  }

  /* When user has scrolled a bit, hide bottom hint and show top fade */
  aside.scrolled::after,
  aside.hint-hidden::after { background: linear-gradient(to top, var(--panel), transparent); }
  aside.scrolled::before   { display: block; }
  aside.hint-hidden .scroll-hint { display: none; }
}

  </style>
</head>
<body>
<div id="app">
  <header>
  <div class="brand">
    <img class="logo" src="/data/logo.png" alt="New Horizon Economics logo" />
    <div>
      <h1>New Horizon Economics | Index of Multiple Deprivation 2025</h1>
      <div class="sub">REWEIGHTABLE IMD DIMENSIONS</div>
    </div>
  </div>
</header>
  <aside>
    <div class="group">
      <div class="row-inline">
        <button id="fitBtn">Reset map</button>
        <button id="legendToggle" class="outline" style="flex:1">Hide legend</button>
      </div>
    </div>
<div class="scroll-hint">Scroll for more ▼</div>
    <div class="group">
  <label>Search by name or code</label>
  <input id="searchBox" type="text" placeholder="e.g. E01000001 or Plymouth" />
  <div id="searchResults" class="row" style="display:none; max-height:180px; overflow:auto; margin-top:8px;"></div>
</div>

<div class="group">
  <div id="infoBox" class="row" style="display:none;">
    <div style="font-weight:700; margin-bottom:4px;" id="infoName">—</div>
    <div style="font-size:12px; color:var(--muted);" id="infoCode">—</div>
    <div style="margin-top:6px;">
      <div>Rank: <strong id="infoRank">—</strong></div>
      <div>Decile: <strong id="infoDecile">—</strong></div>
    </div>
  </div>
</div>

    <div id="sliders"></div>

   <div class="group btns">
     <button id="reset">Reset weights</button>
     <button id="exportCsv" class="outline">Export CSV</button>
 
    </div>

    <div class="group" style="font-size:12px;color:var(--muted)">
      Data: <code>/data/areas.geojson</code>, <code>/data/file9.csv</code> (headers must include domain columns).
    </div>
  </aside>

  <main>
    <div id="map"></div>
    <div id="legend" class="legend"></div>
  </main>
</div>



<script defer>
(function(){
  // --- Config
  const GEO_URL = '/data/areas.geojson';
  const CSV_URL = '/data/file9.csv';

  // Displayed slider labels
  const DOMAIN_KEYS = [
    ["dom_income","Income "],
    ["dom_employment","Employment "],
    ["dom_education","Education "],
    ["dom_health","Health "],
    ["dom_crime","Crime "],
    ["dom_barriers","Barriers to Housing & Services "],
    ["dom_living","Living Environment "],
  ];

  // CSV column names for File 9
  const DK_MAP = {
    dom_income: "income",
    dom_employment: "employ",
    dom_education: "educ",
    dom_health: "health",
    dom_crime: "crime",
    dom_barriers: "barrier",
    dom_living: "living",
  };

  const DEFAULT_WEIGHTS = {
    dom_income:22.5, dom_employment:22.5, dom_education:13.5,
    dom_health:13.5, dom_crime:9.3, dom_barriers:9.3, dom_living:9.3
  };

  // GeoJSON property keys
  const GEO_CODE_KEY = "LSOA21CD";
  const GEO_NAME_KEY = "LSOA21NM";
  const CODE_COL     = "LSOA21CD"; // CSV header you renamed

  // Colours (1=red … 5=white … 10=green)
  const PALETTE = ["#d73027","#f46d43","#fdae61","#fee08b","#ffffff","#e6f5d0","#a1d76a","#66bd63","#1a9850","#006837"];
  const NO_DATA_FILL = "#3a4258";

  // --- State
  let map, layer, areasFC = null, file9 = [];
  const weights = {...DEFAULT_WEIGHTS};

  // Selection / join globals
  let SELECTED_CODE = null;          // current LSOA (UPPERCASE)
  let selectedLayer = null;          // current highlighted Leaflet layer
  let LAYER_BY_CODE = new Map();     // code -> Leaflet layer
  let FEATURE_META  = new Map();     // code -> {name}
  let FILE9_INDEX   = new Map();     // code -> index in file9[]
  let LAST_RANKS    = [];
  let LAST_DECILES  = [];

  let legendVisible = JSON.parse(localStorage.getItem('legendVisible') ?? 'true');

  // --- Helpers
  const firstXY = (c)=>{ if(!c) return null; if (typeof c[0]==='number') return c; for(const d of c){ const v=firstXY(d); if(v) return v; } return null; };
  function looksLike27700(gj){ try{ const xy = firstXY(gj?.features?.[0]?.geometry?.coordinates)||[]; const [x,y]=xy; return Math.abs(x)>180||Math.abs(y)>90; }catch{ return false; } }
  const EPSG27700_DEF = '+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,125.157,542.06,0.1502,0.2470,0.8421,-20.4894 +units=m +no_defs';
  function reproject27700toWGS84(gj){
    if (!window.proj4) return gj;
    proj4.defs('EPSG:27700', EPSG27700_DEF);
    const fwd = (xy)=> proj4('EPSG:27700','WGS84',xy);
    function rp(coords){ if (typeof coords[0]==='number'){ const [x,y]=coords; const [lon,lat]=fwd([x,y]); return [lon,lat]; } return coords.map(rp); }
    const out = JSON.parse(JSON.stringify(gj));
    for (const f of out.features){ if (f.geometry?.coordinates){ f.geometry.coordinates = rp(f.geometry.coordinates); } }
    return out;
  }
  function normalizeWeights(w){
    const s = Object.values(w).reduce((a,b)=>a+(b||0),0) || 1;
    const o={}; for (const k in w) o[k]= (w[k]||0)/s; return o;
  }
  function weightedScore(row, normW){
    let s=0; for (const k in DK_MAP){ s += Number(row[DK_MAP[k]]) * (normW[k]||0); } return s;
  }
  function rankAndDeciles(vals){
    const idx = vals.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v);
    const ranks=new Array(vals.length).fill(0), dec=new Array(vals.length).fill(0);
    idx.forEach((o,p)=>{ ranks[o.i]=p+1; const d=Math.ceil(((p+1)/vals.length)*10); dec[o.i]=Math.min(10,Math.max(1,d)); });
    return {ranks,deciles:dec};
  }
  function colorFor(dec){
    if(!Number.isFinite(dec)) return NO_DATA_FILL;
    const i = Math.max(1, Math.min(10, dec)) - 1;
    return PALETTE[i];
  }
  const cleanStr = v => String(v ?? "").replace(/^\uFEFF/, "").trim();
  const num = v => { const s = cleanStr(v).replace(/[\s,]/g,"").replace(/[−–—]/g,"-"); const x = +s; return Number.isFinite(x) ? x : NaN; };
  const normKey = s => String(s ?? "").trim().toUpperCase();

  // Search helpers
  function findMatches(query){
    const q = normKey(query);
    if (!q || q.length < 2) return [];
    const out = [];
    for (const [code] of LAYER_BY_CODE.entries()){
      if (code.includes(q)) out.push({ code, name: FEATURE_META.get(code)?.name || code });
    }
    for (const [code, meta] of FEATURE_META.entries()){
      const nameU = normKey(meta?.name || "");
      if (nameU.includes(q) && !out.some(o => o.code === code)) out.push({ code, name: meta?.name || code });
    }
    out.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    return out.slice(0, 200);
  }
  function focusLayerSmart(lyr){
    const b = lyr.getBounds();
    const curZoom = map.getZoom();
    const fitZoom = map.getBoundsZoom(b, true);
    const MAX_ALLOWED = 11;
    const desired = Math.min(fitZoom, MAX_ALLOWED);
    if (desired > curZoom + 0.75) {
      map.fitBounds(b, { padding: [24,24], maxZoom: MAX_ALLOWED });
    } else {
      map.panTo(b.getCenter());
    }
  }
  function showResults(matches){
    const box = document.getElementById('searchResults');
    if (!box) return;
    if (!matches.length){ box.style.display='none'; box.innerHTML=''; return; }
    box.style.display = 'block';
    box.innerHTML = matches.map(m =>
      `<button data-code="${m.code}" style="display:block;width:100%;text-align:left;background:transparent;border:1px solid var(--border);border-radius:8px;padding:6px 8px;margin:4px 0;color:var(--text)">
         <div style="font-weight:600">${m.name}</div>
         <div style="font-size:12px;color:var(--muted)">${m.code}</div>
       </button>`
    ).join('');
    box.querySelectorAll('button[data-code]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        selectByCode(btn.getAttribute('data-code'));
        box.style.display = 'none';
      });
    });
  }
  function refreshInfoBoxFromSelection(){
    if (!SELECTED_CODE) return;
    const code = SELECTED_CODE;
    const info = document.getElementById('infoBox');
    const nmEl = document.getElementById('infoName');
    const cdEl = document.getElementById('infoCode');
    const rkEl = document.getElementById('infoRank');
    const dcEl = document.getElementById('infoDecile');
    if (!info || !nmEl || !cdEl || !rkEl || !dcEl) return;
    const i  = FILE9_INDEX.get(code);
    const rk = (i != null) ? LAST_RANKS[i]   : NaN;
    const dc = (i != null) ? LAST_DECILES[i] : NaN;
    const n  = LAST_DECILES.length;
    nmEl.textContent = FEATURE_META.get(code)?.name || code;
    cdEl.textContent = code;
    rkEl.textContent = Number.isFinite(rk) ? `${rk} / ${n}` : '—';
    dcEl.textContent = Number.isFinite(dc) ? `${dc}` : '—';
    info.style.display = 'block';
  }
  function selectByCode(codeRaw){
    const code = String(codeRaw ?? "").trim().toUpperCase();
    if (!code) return;
    const lyr = LAYER_BY_CODE.get(code);
    if (!lyr) { console.warn("Code not found:", code); return; }
    if (selectedLayer) selectedLayer.setStyle({ weight: 1.1, color: '#9fb6e6' });
    lyr.setStyle({ weight: 3, color: '#fff', dashArray: '2,3' });
    selectedLayer = lyr;
    SELECTED_CODE = code;
    focusLayerSmart(lyr);
    refreshInfoBoxFromSelection();
    try { if (lyr.getTooltip && lyr.getTooltip()) lyr.openTooltip(); } catch {}
  }

  // --- UI pieces
  const slidersDiv = document.getElementById('sliders');
  const normLabel = {}; // key -> span element

  function refreshWeightLabels(){
    const norm = normalizeWeights(weights);
    Object.keys(normLabel).forEach(k => {
      const el = normLabel[k];
      if (el) el.textContent = `${(norm[k] * 100).toFixed(1)}%`;
    });
  }
  function renderSliders(){
    slidersDiv.innerHTML = '';
    const norm = normalizeWeights(weights);
    DOMAIN_KEYS.forEach(([key, label]) => {
      const wrap = document.createElement('div');
      wrap.className = 'row';
      const top = document.createElement('label');
      const pct = ((norm[key] || 0) * 100).toFixed(1);
      top.innerHTML = `<span>${label}</span><span id="lab-${key}">${pct}%</span>`;
      const input = document.createElement('input');
      input.type = 'range'; input.min='0'; input.max='40'; input.step='0.1';
      input.value = String(weights[key]);
      input.addEventListener('input', ()=>{
        weights[key] = Number(input.value);
        refreshWeightLabels();
        updateAll();                  // recompute ranks/deciles + recolour
        refreshInfoBoxFromSelection();// keep sidebar in sync
      });
      wrap.appendChild(top);
      wrap.appendChild(input);
      slidersDiv.appendChild(wrap);
      normLabel[key] = top.querySelector('span:last-child');
    });
  }
  function updateLegend(){
    const el = document.getElementById('legend');
    let html = `<div style="font-weight:700;margin-bottom:6px">Deciles (1 = most deprived)</div>`;
    for(let i=0;i<10;i++){
      html += `<div class="row"><span class="swatch" style="background:${PALETTE[i]}"></span> ${i+1}</div>`;
    }
    html += `<div class="row"><span class="swatch" style="background:${NO_DATA_FILL}"></span> No data</div>`;
    el.innerHTML = html;
    el.style.display = legendVisible ? 'block' : 'none';
    const btn = document.getElementById('legendToggle');
    if (btn) btn.textContent = legendVisible ? 'Hide legend' : 'Show legend';
  }

  // Draw polygons & wire per-feature events, also build LAYER_BY_CODE/META
  function draw(){
    if(layer) { map.removeLayer(layer); layer=null; }
    LAYER_BY_CODE.clear();
    FEATURE_META.clear();
    layer = L.geoJSON(areasFC, {
      style: ()=>({color:'#9fb6e6',weight:1.1,fillColor:NO_DATA_FILL,fillOpacity:0.9}),
      onEachFeature: (f,l)=>{
        const props = (f && f.properties) ? f.properties : {};
        const code  = String((props[GEO_CODE_KEY] ?? f.id ?? "")).trim().toUpperCase();
        const rawName = props[GEO_NAME_KEY];
        const name = String(
          (rawName !== undefined && rawName !== null && rawName !== "") ? rawName : (code || "Area")
        );
        if (code) {
          LAYER_BY_CODE.set(code, l);
          FEATURE_META.set(code, { name });
        }
        l.on({
          mouseover:e=>{
            e.target.setStyle({ weight: 2, color: '#fff', fillColor: e.target._currentFill, fillOpacity: 1 });
          },
          mouseout:e=>{
            if (selectedLayer && e.target === selectedLayer) return;
            e.target.setStyle({ weight: 1.1, color: '#9fb6e6', fillOpacity: 0.9 });
          },
          click:()=>{ if (code) selectByCode(code); }
        });
      }
    }).addTo(map);
    map.fitBounds(layer.getBounds(),{padding:[20,20]});
  }

  // Recompute, recolour, refresh tooltips & sidebar
  function updateAll(){
    if (!layer || !file9.length) return;

    const normW = normalizeWeights(weights);
    const scores = file9.map(r =>
      (Number(r.income)  || 0) * normW.dom_income     +
      (Number(r.employ)  || 0) * normW.dom_employment +
      (Number(r.educ)    || 0) * normW.dom_education  +
      (Number(r.health)  || 0) * normW.dom_health     +
      (Number(r.crime)   || 0) * normW.dom_crime      +
      (Number(r.barrier) || 0) * normW.dom_barriers   +
      (Number(r.living)  || 0) * normW.dom_living
    );

    const rd = rankAndDeciles(scores);
    LAST_RANKS   = rd.ranks;
    LAST_DECILES = rd.deciles;

    FILE9_INDEX = new Map();
    file9.forEach((r,i)=> FILE9_INDEX.set(r.LSOA21CD, i));

    const n = LAST_DECILES.length;
    let matched = 0, total = 0;

    layer.eachLayer(l=>{
      total++;
      const props = l.feature?.properties || {};
      const code  = String(props[GEO_CODE_KEY] ?? "").trim().toUpperCase();
      const name = String(
        (props[GEO_NAME_KEY] !== undefined && props[GEO_NAME_KEY] !== null && props[GEO_NAME_KEY] !== "")
          ? props[GEO_NAME_KEY] : (code || "Area")
      );
      const i   = FILE9_INDEX.get(code);
      const dec = (i != null) ? LAST_DECILES[i] : NaN;
      const rk  = (i != null) ? LAST_RANKS[i]   : NaN;

      const fill = colorFor(dec);
      l._currentFill = fill;
      l.setStyle({ fillColor: fill });

      if (SELECTED_CODE && code === SELECTED_CODE) {
        selectedLayer = l;
        l.setStyle({ weight: 3, color: '#fff', dashArray: '2,3' });
      }

      FEATURE_META.set(code, { name });

      const tip = `
        <div>
          <strong>${name}</strong><br/>
          <span style="opacity:.75">${code}</span><br/>
          Rank: <strong>${Number.isFinite(rk) ? `${rk} / ${n}` : '—'}</strong><br/>
          Decile: <strong>${Number.isFinite(dec) ? dec : '—'}</strong>
        </div>`;
      l.bindTooltip(tip, { sticky:true, opacity:0.95, className:'tooltip' });

      if (Number.isFinite(dec)) matched++;
    });

    console.log(`[JOIN] matched ${matched} of ${total}`);
    refreshWeightLabels();
    updateLegend();
    refreshInfoBoxFromSelection();
  }

  // CSV export (baseline vs scenario)
  function exportCSV(){
    if (!file9?.length) return;

    const baseW = normalizeWeights(DEFAULT_WEIGHTS);
    const scenW = normalizeWeights(weights);

    const baseScores = file9.map(r =>
      (Number(r.income)||0)*baseW.dom_income +
      (Number(r.employ)||0)*baseW.dom_employment +
      (Number(r.educ)||0)*baseW.dom_education +
      (Number(r.health)||0)*baseW.dom_health +
      (Number(r.crime)||0)*baseW.dom_crime +
      (Number(r.barrier)||0)*baseW.dom_barriers +
      (Number(r.living)||0)*baseW.dom_living
    );
    const scenScores = file9.map(r =>
      (Number(r.income)||0)*scenW.dom_income +
      (Number(r.employ)||0)*scenW.dom_employment +
      (Number(r.educ)||0)*scenW.dom_education +
      (Number(r.health)||0)*scenW.dom_health +
      (Number(r.crime)||0)*scenW.dom_crime +
      (Number(r.barrier)||0)*scenW.dom_barriers +
      (Number(r.living)||0)*scenW.dom_living
    );

    const {ranks: baseRanks,  deciles: baseDeciles}  = rankAndDeciles(baseScores);
    const {ranks: scenRanks,  deciles: scenDeciles}  = rankAndDeciles(scenScores);

    const rows = file9.map((r, i) => ({
      LSOA21CD: r.LSOA21CD,
      base_score:  baseScores[i],
      base_rank:   baseRanks[i],
      base_decile: baseDeciles[i],
      scen_score:  scenScores[i],
      scen_rank:   scenRanks[i],
      scen_decile: scenDeciles[i],
      base_w_income:     (baseW.dom_income*100).toFixed(1),
      base_w_employment: (baseW.dom_employment*100).toFixed(1),
      base_w_education:  (baseW.dom_education*100).toFixed(1),
      base_w_health:     (baseW.dom_health*100).toFixed(1),
      base_w_crime:      (baseW.dom_crime*100).toFixed(1),
      base_w_barriers:   (baseW.dom_barriers*100).toFixed(1),
      base_w_living:     (baseW.dom_living*100).toFixed(1),
      scen_w_income:     (scenW.dom_income*100).toFixed(1),
      scen_w_employment: (scenW.dom_employment*100).toFixed(1),
      scen_w_education:  (scenW.dom_education*100).toFixed(1),
      scen_w_health:     (scenW.dom_health*100).toFixed(1),
      scen_w_crime:      (scenW.dom_crime*100).toFixed(1),
      scen_w_barriers:   (scenW.dom_barriers*100).toFixed(1),
      scen_w_living:     (scenW.dom_living*100).toFixed(1),
    }));

    const cols = Object.keys(rows[0]);
    const esc  = (s) => `"${String(s).replaceAll('"','""')}"`;
    const csv  = [cols.map(esc).join(','), ...rows.map(r => cols.map(c => esc(r[c] ?? '')).join(','))].join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = `imd_baseline_vs_scenario_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // --- App bootstrap
  window.addEventListener('DOMContentLoaded', async ()=>{
    map = L.map('map',{preferCanvas:true,zoomSnap:0.25,zoomDelta:0.5}).setView([53.9,-2.5],6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                {attribution:'&copy; OpenStreetMap, &copy; CARTO'}).addTo(map);

    document.getElementById('fitBtn').addEventListener('click', ()=>{ if(layer) map.fitBounds(layer.getBounds(),{padding:[20,20]}); });
    document.getElementById('legendToggle').addEventListener('click', ()=>{
      legendVisible = !legendVisible; updateLegend(); localStorage.setItem('legendVisible', JSON.stringify(legendVisible));
    });
    document.getElementById('reset').addEventListener('click', ()=>{
      Object.assign(weights, DEFAULT_WEIGHTS);
      renderSliders();
      updateAll();
    });
    document.getElementById('exportCsv').addEventListener('click', exportCSV);

    // Search wiring
    const searchBox = document.getElementById('searchBox');
    const resultsEl = document.getElementById('searchResults');
    if (searchBox) {
      searchBox.addEventListener('input', ()=>{
        const q = searchBox.value;
        if (q.length < 2) { resultsEl.style.display='none'; resultsEl.innerHTML=''; return; }
        const matches = findMatches(q);
        if (matches.length === 1) { showResults(matches); selectByCode(matches[0].code); }
        else { showResults(matches); }
      });
      searchBox.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') {
          const q = searchBox.value;
          const matches = findMatches(q);
          if (matches.length === 1) { selectByCode(matches[0].code); resultsEl.style.display='none'; }
        }
      });
    }

    renderSliders();
    updateLegend();

    try {
      // GeoJSON
      const g = await fetch(GEO_URL, {cache:'no-store'});
      if (!g.ok) throw new Error('Geo fetch failed: '+g.status);
      const raw = await g.json();
      areasFC = looksLike27700(raw) ? reproject27700toWGS84(raw) : raw;
      console.log("[GEO] sample:", areasFC?.features?.[0]?.properties);

      // File9 CSV/TSV
      const res = await fetch(CSV_URL, {cache:'no-store'});
      if (!res.ok) throw new Error('CSV fetch failed: '+res.status);
      const txt = await res.text();
      const guessTab = txt.split('\n',1)[0].includes('\t');
      const parsed = Papa.parse(txt, {
        header: true, dynamicTyping: false, skipEmptyLines: true,
        delimiter: guessTab ? '\t' : ','
      });
      file9 = (parsed.data || []).map(r => ({
        LSOA21CD: String(r[CODE_COL] ?? "").trim().toUpperCase(),
        income:  num(r.income),
        employ:  num(r.employ),
        educ:    num(r.educ),
        health:  num(r.health),
        crime:   num(r.crime),
        barrier: num(r.barrier),
        living:  num(r.living),
      }));
      console.log("[FILE9] rows:", file9.length, "sample:", file9[0]);

      window.__areas = areasFC;
      window.__file9 = file9;

      draw();
      updateAll();
    } catch (err) {
      console.error(err);
      alert('Failed to load map/data. See console.');
    }
  });
  // Mobile scroll hint: hide after first real scroll and remember preference
const asideEl = document.querySelector('aside');
if (asideEl) {
  const hideHint = () => asideEl.classList.add('hint-hidden');
  if (localStorage.getItem('asideHintHidden') === '1') hideHint();

  asideEl.addEventListener('scroll', () => {
    if (asideEl.scrollTop > 8) {
      asideEl.classList.add('scrolled');
      if (!asideEl.classList.contains('hint-hidden')) {
        hideHint();
        localStorage.setItem('asideHintHidden', '1');
      }
    } else {
      asideEl.classList.remove('scrolled');
    }
  }, { passive: true });
}

})();
</script>

</body>
</html>
